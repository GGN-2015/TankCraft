# Windows课程设计-坦克大战

21200723 马昭，21200612 郭冠男。

项目详见：https://github.com/GGN-2015/TankCraft

## 客户端 （马昭负责）

### 主体

##### 采用对象管理的方法进行编程，方便前端编程扩展，更加符合逻辑直觉

程序由一个主类进行平台与实际程序间的调度，具体调度由主类创建的多个管理器分别管理。其中游戏管理器负责游戏内逻辑，输入管理器负责读取键盘/鼠标输入，渲染管理器负责显示画面……

### 流程

初始时，先初始化平台管理器——创建窗口，然后初始化渲染管理器——创建direct的相关资源，然后初始化对象管理器——游戏中的代码挂载在对象管理器上，然后初始化输入输出管理器——管理输入输出，然后将游戏管理器组件挂在到对象管理器创建的新物体上，来启动游戏。

游戏管理器会初始化各个子管理器来辅助游戏运行。

每帧都会尝试处理接收到的服务端的消息，并尝试发送按键消息。当接收到服务端消息时会根据类型id，初步处理后交给各个子管理器处理。

### 细节

将float包装成Float类，方便进行各种处理，并创建Vector2、3、4类来方便对一些可能作为短小数组的数据进行处理，使代码更符合直觉。

制作了各种小组件，制作书写类似代码或更换游戏时可以进行方便的复用。

通过网络管理器分割为两个线程，前端如果卡顿不影响网络通信。

## 服务端（郭冠男负责）

### 主体

服务端没有图形用户界面，主体分为“通信”，“算法”，“控制”三部分。通信层抽象了与客户端之间进行 TCP 通信的接口，能够将从客户端获取到的二进制数据解析成对应消息的对象，再在控制部分进行数据注册。算法层抽象了诸如地图生成算法等与游戏性关联较小的算法部分，以实现功能的复用。控制部分负责控制游戏服务端的逻辑，如注册玩家信息、修改玩家得分、对游戏地图中的图形进行判交以及子弹的反弹处理等工作。

### 线程

当客户端与服务端建立连接时，服务端派生出一个新的线程与该客户端进行通信，当客户端下线时，服务端的对应线程结束。服务端使用一个独立的线程运行游戏的物理引擎算法，每5ms重新计算各个实体的位置并进行碰撞检测与反弹处理。服务端和客户端的通讯遵循一套我们制定的通信协议，详见文件“通信协议.md”。

### 细节

DataParser类负责将收到的二进制数据 TcpData 翻译成对应的 IRequest 子类，DataParser 从全局解析器表中选择合适的解析器进行解析，每个 IRequest 子类对应一个 IParser 子类，构成 Chain of Responsibility 模式。在起初的时候发现了严重的内存泄露问题，后来经调试发现程序在主体实现上并没有问题，而是 IMessage 类的析构函数忘了定义成虚函数，导致子类对象没有正确地释放。在地图生成上，我们的算法能够保证地图中没有任何一个格子会被“孤立”，换言之整个地图一定处处连通。

